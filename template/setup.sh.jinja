#!/bin/bash
# ABOUTME: Initializes a git worktree-based project from a bare clone.
# ABOUTME: Creates the bare repo, pointer file, worktrees, and local excludes.

set -euo pipefail

REMOTE_URL="{{ git_remote_url }}"
DEFAULT_BRANCH="{{ default_branch }}"

echo "Setting up worktree-based project..."

# Clone as bare repository
git clone --bare "$REMOTE_URL" .bare

# Create .git pointer file so git commands work from the project root
echo "gitdir: ./.bare" > .git

# Configure fetch refs for all branches (bare clones only fetch the default)
git config remote.origin.fetch "+refs/heads/*:refs/remotes/origin/*"

# Use relative paths so the project directory is portable
git config worktree.useRelativePaths true

# Fetch all remote branches
git fetch --all

# Add the default branch as the first worktree
git worktree add "$DEFAULT_BRANCH" "$DEFAULT_BRANCH"

# Set up local excludes (these stay outside version control)
cat >> .bare/info/exclude << 'EXCLUDE'

# Project-level files (outside version control)
bin/
_/
.claude/
.cursor/
setup.sh
AGENTS.md
CLAUDE.md
*.env
.env.*
flake.nix
flake.lock
mise.toml
.mise.toml
.copier-answers.yml
EXCLUDE

# Create optional directories
{% if include_scratchpad %}mkdir -p _
{% endif %}{% if include_claude_config %}mkdir -p .claude
{% endif %}
# Create CLAUDE.md symlink pointing to AGENTS.md
ln -sf AGENTS.md CLAUDE.md

# Make helper scripts executable
chmod +x bin/*

echo ""
echo "Project initialized!"
echo "  Bare repo: .bare/"
echo "  Worktree:  $DEFAULT_BRANCH/"
echo ""
echo "Helper scripts:"
echo "  bin/wt-add <branch> [base]  - Create a new worktree"
echo "  bin/wt-rm <branch>          - Remove a worktree"
echo "  bin/wt-ls                   - List all worktrees"
echo ""
echo "Next steps:"
echo "  cd $DEFAULT_BRANCH/"
