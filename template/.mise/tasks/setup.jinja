#!/bin/bash
# mise description="Initialize the bare repo and worktree structure (runs once during scaffolding)"

set -euo pipefail

REMOTE_URL="{{ git_remote_url }}"
DEFAULT_BRANCH="{{ default_branch }}"

echo "Setting up worktree-based project..."

# Clone as bare repository
git clone --bare "$REMOTE_URL" .bare

# Create .git pointer file so git commands work from the project root
echo "gitdir: ./.bare" > .git

# Configure fetch refs for all branches (bare clones only fetch the default)
git config remote.origin.fetch "+refs/heads/*:refs/remotes/origin/*"

# Use relative paths so the project directory is portable
git config worktree.useRelativePaths true

# Fetch all remote branches
git fetch --all

# Add the default branch as the first worktree
git worktree add "$DEFAULT_BRANCH" "$DEFAULT_BRANCH"

# Set up local excludes (these stay outside version control)
cat >> .bare/info/exclude << 'EXCLUDE'

# Project-level files (outside version control)
.mise/
.mise.toml
mise.toml
_/
.claude/
.cursor/
AGENTS.md
CLAUDE.md
*.env
.env.*
flake.nix
flake.lock
.copier-answers.yml
EXCLUDE

# Create directories for scratchpad and agent config
mkdir -p _ .claude

# Create CLAUDE.md symlink pointing to AGENTS.md
ln -sf AGENTS.md CLAUDE.md

echo ""
echo "Project initialized!"
echo "  Bare repo: .bare/"
echo "  Worktree:  $DEFAULT_BRANCH/"
echo ""
echo "Tasks (via mise):"
echo "  mise run wt-add <branch> [base]  - Create a new worktree"
echo "  mise run wt-rm <branch>          - Remove a worktree"
echo "  mise run wt-ls                   - List all worktrees"
echo ""
echo "Next steps:"
echo "  cd $DEFAULT_BRANCH/"
