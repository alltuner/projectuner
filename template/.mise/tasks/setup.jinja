#!/bin/bash
#MISE description="Initialize the bare repo and worktree structure (runs once during scaffolding)"

set -euo pipefail

REMOTE_URL="{{ git_remote_url }}"

echo "Setting up worktree-based project..."

if [ -n "$REMOTE_URL" ]; then
  # Clone existing remote as bare repository
  git clone --bare "$REMOTE_URL" .bare
  export GIT_DIR=.bare
  git config remote.origin.fetch "+refs/heads/*:refs/remotes/origin/*"
  git config worktree.useRelativePaths true
  git fetch --all
  git worktree add main main
else
  # Start a fresh bare repo with no remote
  git init --bare .bare
  export GIT_DIR=.bare
  git config worktree.useRelativePaths true

  # Create an initial empty commit so worktrees can be added
  TREE=$(git hash-object -t tree /dev/null)
  COMMIT=$(echo "Initial commit" | git commit-tree "$TREE")
  git update-ref refs/heads/main "$COMMIT"
  git worktree add main main
fi

# Create directories for scratchpad and agent config
mkdir -p _ .claude

echo ""
echo "Project initialized!"
echo "  Bare repo: .bare/"
echo "  Worktree:  main/"
if [ -n "$REMOTE_URL" ]; then
  echo "  Remote:    $REMOTE_URL"
else
  echo "  Remote:    (none, add one later with: mise run remote-add <owner/repo>)"
fi
echo ""
echo "Tasks (via mise):"
echo "  mise run wt-add <branch> [base]  - Create a new worktree"
echo "  mise run wt-rm <branch>          - Remove a worktree"
echo "  mise run wt-ls                   - List all worktrees"
echo ""
echo "Next steps:"
echo "  mise run wt-add <your-branch>"
