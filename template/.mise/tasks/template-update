#!/bin/bash
#MISE description="Update template files via copier (works around bare repo limitation)"

# ABOUTME: Runs copier update in a temporary git repo, then syncs results back.
# ABOUTME: Needed because copier rejects bare repo + worktree project roots.

set -euo pipefail

if ! command -v uvx &>/dev/null; then
  echo "Error: uvx is required but not found. Install uv first." >&2
  exit 1
fi

if [ ! -f .copier-answers.yml ]; then
  echo "Error: .copier-answers.yml not found. Is this a copier-managed project?" >&2
  exit 1
fi

# Collect directories to exclude from copy (worktrees, bare repo, scratch areas)
EXCLUDE_ARGS=(--exclude .bare/ --exclude .git --exclude _/ --exclude .claude/)

while IFS= read -r wt_path; do
  [ -z "$wt_path" ] && continue
  # Convert absolute worktree path to a name relative to project root
  wt_name="${wt_path##*/}"
  EXCLUDE_ARGS+=(--exclude "$wt_name/")
done < <(git worktree list --porcelain | awk '/^worktree /{print $2}')

# Resolve symlinks (macOS /var -> /private/var) so copier path comparisons work
TMPDIR=$(realpath "$(mktemp -d)")
trap 'rm -rf "$TMPDIR"' EXIT

# Snapshot template-managed files before update
rsync -a "${EXCLUDE_ARGS[@]}" ./ "$TMPDIR/"

# Record files present before copier runs
BEFORE=$(mktemp)
(cd "$TMPDIR" && find . -not -path './.git/*' -not -name '.git' -type f | sort) > "$BEFORE"

# Give copier a git repo to work with
git -C "$TMPDIR" init --quiet
git -C "$TMPDIR" add -A
git -C "$TMPDIR" commit --quiet -m "pre-update snapshot"

# Run copier update, passing through any extra args
if ! uvx copier update --trust "$@" "$TMPDIR"; then
  echo "Error: copier update failed." >&2
  exit 1
fi

# Record files present after copier runs
AFTER=$(mktemp)
(cd "$TMPDIR" && find . -not -path './.git/*' -not -name '.git' -type f | sort) > "$AFTER"

# Sync updated files back (exclude the temp git repo)
rsync -a --exclude .git "$TMPDIR/" ./

# Remove files that copier deleted (present before but not after)
while IFS= read -r deleted; do
  target="./$deleted"
  if [ -f "$target" ]; then
    rm "$target"
    echo "Removed: $deleted"
  fi
done < <(comm -23 "$BEFORE" "$AFTER")

rm -f "$BEFORE" "$AFTER"

echo "Template update complete."
